function m(e){try{return new URL(e).hostname}catch{return""}}function f(){return`${Date.now()}-${Math.random().toString(36).slice(2,11)}`}const r={apiKey:"",model:"anthropic/claude-sonnet-4",temperature:.7,maxTokens:4096};async function i(){return(await chrome.storage.local.get("config")).config??r}async function d(e){const n=await i();await chrome.storage.local.set({config:{...n,...e}})}async function h(e){const t=(await chrome.storage.local.get("scripts")).scripts??{};t[e.domain]||(t[e.domain]=[]);const a=t[e.domain].findIndex(s=>s.id===e.id);a>=0?t[e.domain][a]=e:t[e.domain].push(e),await chrome.storage.local.set({scripts:t})}async function g(e,n){const a=(await chrome.storage.local.get("scripts")).scripts??{};a[e]&&(a[e]=a[e].filter(s=>s.id!==n),await chrome.storage.local.set({scripts:a}))}async function p(e){return((await chrome.storage.local.get("siteContexts")).siteContexts??{})[e]??null}async function $(e){const t=(await chrome.storage.local.get("siteContexts")).siteContexts??{};t[e.domain]=e,await chrome.storage.local.set({siteContexts:t})}async function y(){await chrome.storage.local.clear()}function w(e){return`You are Quark, an AI assistant that helps users customize and modify websites by generating JavaScript code to inject into web pages.

Your role is to:
1. Understand the user's intent for website modifications
2. Analyze the provided website context (APIs, DOM structure)
3. Generate clean, safe, and effective JavaScript code

Guidelines for code generation:
- Write self-contained JavaScript that runs in the page context
- Use modern ES6+ syntax
- Handle errors gracefully with try-catch blocks
- Avoid infinite loops or recursive calls that could crash the page
- Do not make requests to external domains unless specifically requested
- Prefer querySelector/querySelectorAll for DOM manipulation
- For API interception, use fetch/XMLHttpRequest wrapping patterns
- Add comments explaining what the code does

Response format:
1. Brief explanation of what you'll do
2. JavaScript code in a \`\`\`javascript code block
3. Any caveats or notes about the implementation

Current website context:
- Domain: ${e.domain}
- URL: ${e.url}
- Title: ${e.title}`}function v(e,n){let t=`User request: ${e}

`;return n.apis.length>0&&(t+=`Available APIs detected on this page:
`,t+=c(n.apis),t+=`
`),(n.dom.interactiveElements.length>0||n.dom.dataContainers.length>0)&&(t+=`DOM Structure:
`,t+=u(n.dom),t+=`
`),t+="Generate JavaScript code to accomplish the user's request. Make sure the code is safe, efficient, and handles edge cases.",t}function c(e){let n="";for(const t of e){n+=`
### ${t.name} (${t.type})
`;for(const a of t.endpoints.slice(0,10))n+=l(a);t.endpoints.length>10&&(n+=`  ... and ${t.endpoints.length-10} more endpoints
`)}return n}function l(e){let n=`- ${e.method} ${e.path}`;return Object.keys(e.queryParams).length>0&&(n+=` (params: ${Object.keys(e.queryParams).join(", ")})`),e.authType&&e.authType!=="none"&&(n+=` [auth: ${e.authType}]`),n+=` - called ${e.callCount}x
`,e.requestSchema&&(n+=`    Request schema: ${JSON.stringify(e.requestSchema,null,2).substring(0,200)}
`),n}function u(e){let n="";if(e.interactiveElements.length>0){n+=`
Interactive Elements:
`;for(const t of e.interactiveElements.slice(0,10))n+=o(t)}if(e.dataContainers.length>0){n+=`
Data Containers:
`;for(const t of e.dataContainers.slice(0,10))n+=o(t)}if(e.forms.length>0){n+=`
Forms:
`;for(const t of e.forms.slice(0,5))n+=o(t)}return n}function o(e){let n=`- <${e.tagName.toLowerCase()}`;if(e.id&&(n+=` id="${e.id}"`),e.classes.length>0&&(n+=` class="${e.classes.slice(0,3).join(" ")}"`),n+=`> selector: "${e.selector}"`,e.textContent){const t=e.textContent.substring(0,50);n+=` text: "${t}${e.textContent.length>50?"...":""}"`}return n+=`
`,n}function S(e){return`// ==UserScript==
// @name         ${e.name}
// @namespace    quark-browser-agent
// @version      1.0
// @description  ${e.description}
// @author       Quark Browser Agent
// @match        *://${e.domain}/*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';
    
${e.code.split(`
`).map(n=>"    "+n).join(`
`)}
})();`}function b(e,n){let t=`# Website Analysis Report: ${e.domain}

`;t+=`Generated by Quark Browser Agent
`,t+=`Date: ${new Date().toISOString()}
`,t+=`URL: ${e.url}

`,t+=`## Discovered APIs

`;for(const a of e.apis){t+=`### ${a.name} (${a.type})

`,t+=`| Method | Endpoint | Auth | Calls |
`,t+=`|--------|----------|------|-------|
`;for(const s of a.endpoints)t+=`| ${s.method} | ${s.path} | ${s.authType??"none"} | ${s.callCount} |
`;t+=`
`}t+=`## Generated Scripts

`;for(const a of n)t+=`### ${a.name}

`,t+=`**User Request:** ${a.prompt}

`,t+=`**Description:** ${a.description}

`,t+=`\`\`\`javascript
${a.code}
\`\`\`

`;return t+=`## DOM Structure Summary

`,t+=`- Interactive Elements: ${e.dom.interactiveElements.length}
`,t+=`- Data Containers: ${e.dom.dataContainers.length}
`,t+=`- Forms: ${e.dom.forms.length}
`,t+=`- Navigation Elements: ${e.dom.navigation.length}
`,t}export{i as a,S as b,d as c,g as d,b as e,y as f,f as g,m as h,w as i,v as j,$ as k,p as l,h as s};
