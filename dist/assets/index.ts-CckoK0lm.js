var I=Object.defineProperty;var P=(d,e,t)=>e in d?I(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var g=(d,e,t)=>P(d,typeof e!="symbol"?e+"":e,t);import{h as S,i as q,j as x,a as b,g as T,s as E,k,l as C}from"./prompt-templates-CKGrUK1R.js";class A{constructor(){g(this,"requests",new Map);g(this,"endpoints",new Map);this.setupListeners()}setupListeners(){chrome.webRequest.onBeforeRequest.addListener(e=>this.onBeforeRequest(e),{urls:["<all_urls>"]},["requestBody"]),chrome.webRequest.onSendHeaders.addListener(e=>this.onSendHeaders(e),{urls:["<all_urls>"]},["requestHeaders"]),chrome.webRequest.onCompleted.addListener(e=>this.onCompleted(e),{urls:["<all_urls>"]},["responseHeaders"])}onBeforeRequest(e){if(e.type!=="xmlhttprequest")return;const t={id:e.requestId,url:e.url,method:e.method,headers:{},body:this.extractRequestBody(e.requestBody??void 0),timestamp:e.timeStamp,type:"xhr",initiator:e.initiator};this.requests.set(e.requestId,t)}onSendHeaders(e){const t=this.requests.get(e.requestId);!t||!e.requestHeaders||(t.headers=this.headersToObject(e.requestHeaders))}onCompleted(e){const t=this.requests.get(e.requestId);t&&(this.processEndpoint(t),this.requests.delete(e.requestId))}extractRequestBody(e){if(e){if(e.raw)try{const t=new TextDecoder;return e.raw.map(s=>s.bytes?t.decode(s.bytes):"").join("")}catch{return}if(e.formData)return JSON.stringify(e.formData)}}headersToObject(e){const t={};for(const r of e)r.name&&r.value&&(t[r.name.toLowerCase()]=r.value);return t}processEndpoint(e){const t=S(e.url);if(t)try{const r=new URL(e.url),s=this.normalizePath(r.pathname),l=`${e.method}:${s}`;this.endpoints.has(t)||this.endpoints.set(t,new Map);const c=this.endpoints.get(t),a=c.get(l);if(a){a.callCount++,a.lastCalled=Date.now();const i=this.parseQueryParams(r.search);a.queryParams={...a.queryParams,...i}}else{const i={url:e.url,method:e.method,baseUrl:`${r.protocol}//${r.host}`,path:r.pathname,queryParams:this.parseQueryParams(r.search),authType:this.detectAuthType(e.headers),callCount:1,lastCalled:Date.now()};if(e.body)try{const n=JSON.parse(e.body);i.requestSchema=this.inferSchema(n)}catch{}c.set(l,i)}}catch{}}normalizePath(e){return e.replace(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,"{uuid}").replace(/\/\d+(?=\/|$)/g,"/{id}")}parseQueryParams(e){const t={};return new URLSearchParams(e).forEach((s,l)=>{t[l]=s}),t}detectAuthType(e){var t;return(t=e.authorization)!=null&&t.toLowerCase().startsWith("bearer")?"bearer":e["x-api-key"]||e["api-key"]?"api-key":e.cookie?"cookie":"none"}inferSchema(e){if(e===null)return{type:"null"};if(Array.isArray(e))return{type:"array",items:e.length>0?this.inferSchema(e[0]):{type:"unknown"}};if(typeof e=="object"){const t={};for(const[r,s]of Object.entries(e))t[r]=this.inferSchema(s);return{type:"object",properties:t}}return{type:typeof e}}getAPIsForDomain(e){const t=this.endpoints.get(e);if(!t||t.size===0)return[];const r=Array.from(t.values()),s=r.filter(a=>a.path.includes("graphql")||a.path.includes("gql")),l=r.filter(a=>!a.path.includes("graphql")&&!a.path.includes("gql")),c=[];if(s.length>0&&c.push({name:"GraphQL",endpoints:s,type:"graphql"}),l.length>0){const a=new Map;for(const i of l){const n=i.path.split("/").slice(0,3).join("/")||"/";a.has(n)||a.set(n,[]),a.get(n).push(i)}for(const[i,n]of a)c.push({name:i==="/"?"Root API":i,endpoints:n,type:"rest"})}return c}clearDomain(e){this.endpoints.delete(e)}clearAll(){this.requests.clear(),this.endpoints.clear()}}const y="https://openrouter.ai/api/v1";class R{constructor(e){g(this,"config");this.config=e}async generateScript(e,t){var r,s,l,c;try{const a=q(t),i=x(e,t),n=await fetch(`${y}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json","HTTP-Referer":"chrome-extension://quark-browser-agent","X-Title":"Quark Browser Agent"},body:JSON.stringify({model:this.config.model,messages:[{role:"system",content:a},{role:"user",content:i}],temperature:this.config.temperature??.7,max_tokens:this.config.maxTokens??4096})});if(!n.ok){const p=await n.json().catch(()=>({}));return{error:`API Error: ${n.status} - ${((r=p.error)==null?void 0:r.message)??n.statusText}`}}const u=(c=(l=(s=(await n.json()).choices)==null?void 0:s[0])==null?void 0:l.message)==null?void 0:c.content;return u?this.parseResponse(u):{error:"No response from AI"}}catch(a){return{error:`Request failed: ${a instanceof Error?a.message:String(a)}`}}}parseResponse(e){var a;const t=e.match(/```(?:javascript|js)?\n([\s\S]*?)```/),r=e.match(/(?:Script Name|Name):\s*(.+)/i),s=e.match(/(?:Description):\s*(.+)/i),l=(a=t==null?void 0:t[1])==null?void 0:a.trim();if(!l){const n=e.split(`
`).filter(o=>o.includes("function")||o.includes("const ")||o.includes("let ")||o.includes("document.")||o.includes("window.")||o.includes("fetch(")||o.trim().startsWith("//"));return n.length>0?{code:n.join(`
`),name:(r==null?void 0:r[1])??"Generated Script",description:s==null?void 0:s[1],explanation:e}:{error:"Could not extract JavaScript code from response",explanation:e}}const c=e.replace(/```(?:javascript|js)?\n[\s\S]*?```/g,"").trim();return{code:l,name:(r==null?void 0:r[1])??"Generated Script",description:s==null?void 0:s[1],explanation:c}}async chat(e){var t,r,s,l;try{const c=await fetch(`${y}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json","HTTP-Referer":"chrome-extension://quark-browser-agent","X-Title":"Quark Browser Agent"},body:JSON.stringify({model:this.config.model,messages:e,temperature:this.config.temperature??.7,max_tokens:this.config.maxTokens??4096})});if(!c.ok){const n=await c.json().catch(()=>({}));return{error:`API Error: ${c.status} - ${((t=n.error)==null?void 0:t.message)??c.statusText}`}}return{content:(l=(s=(r=(await c.json()).choices)==null?void 0:r[0])==null?void 0:s.message)==null?void 0:l.content}}catch(c){return{error:`Request failed: ${c instanceof Error?c.message:String(c)}`}}}static async getModels(e){try{const t=await fetch(`${y}/models`,{headers:{Authorization:`Bearer ${e}`}});return t.ok?((await t.json()).data??[]).map(s=>({id:s.id,name:s.name??s.id})):[]}catch{return[]}}}const w=new A,m=new Map;chrome.runtime.onInstalled.addListener(()=>{console.log("Quark Browser Agent installed"),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})});chrome.action.onClicked.addListener(d=>{d.id&&chrome.sidePanel.open({tabId:d.id})});chrome.runtime.onMessage.addListener((d,e,t)=>(v(d,e).then(t),!0));async function v(d,e){var r,s,l,c,a;const t=(r=e.tab)==null?void 0:r.id;switch(d.type){case"GET_SITE_CONTEXT":{const n=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!(n!=null&&n.url))return null;const o=S(n.url);let u=m.get(o);return u||(u=await C(o)??void 0),u?(u.apis=w.getAPIsForDomain(o),u.timestamp=Date.now()):(u={domain:o,url:n.url,title:n.title??"",apis:w.getAPIsForDomain(o),dom:{interactiveElements:[],dataContainers:[],forms:[],navigation:[],timestamp:Date.now()},cookies:[],localStorage:{},timestamp:Date.now()},m.set(o,u)),u}case"DOM_ANALYSIS_RESULT":{const{domain:i,analysis:n}=d.payload,o=m.get(i);return o&&(o.dom=n,o.timestamp=Date.now(),m.set(i,o),await k(o)),{success:!0}}case"GENERATE_SCRIPT":{const{prompt:i,context:n}=d.payload,o=await b();if(!o.apiKey)return{error:"OpenRouter API key not configured"};const p=await new R(o).generateScript(i,n);if(p.error)return{error:p.error};const f={id:T(),name:p.name??"Generated Script",description:p.description??i,code:p.code??"",domain:n.domain,prompt:i,model:o.model,createdAt:Date.now(),updatedAt:Date.now(),enabled:!0,autoRun:!1};return await E(f),{script:f,explanation:p.explanation}}case"INJECT_SCRIPT":{const{code:i,tabId:n}=d.payload,o=n??t;if(console.log("[Quark Background] INJECT_SCRIPT received",{targetTabId:n,senderTabId:t,execTabId:o,codeLength:i.length}),!o)return console.error("[Quark Background] No tab ID provided"),{success:!1,error:"No tab ID provided"};try{const u=await chrome.tabs.get(o);if(console.log("[Quark Background] Injecting into tab:",o,"URL:",u.url),(s=u.url)!=null&&s.startsWith("chrome://")||(l=u.url)!=null&&l.startsWith("chrome-extension://"))return console.error("[Quark Background] Cannot inject into chrome:// or extension pages"),{success:!1,error:"Cannot inject scripts into Chrome internal pages or extension pages"};const p=await chrome.scripting.executeScript({target:{tabId:o},func:f=>{try{console.log("[Quark Injected] Creating script element, code length:",f.length);const h=document.createElement("script");return h.textContent=f,(document.head||document.documentElement).appendChild(h),h.remove(),console.log("[Quark Injected] Script executed successfully"),{success:!0}}catch(h){return console.error("[Quark Injected] Script execution error:",h),{success:!1,error:String(h)}}},args:[i],world:"MAIN"});return console.log("[Quark Background] Script injection result:",p),((c=p[0])==null?void 0:c.result)??{success:!1,error:"No result returned"}}catch(u){return console.error("[Quark Background] Script injection failed:",u),{success:!1,error:u instanceof Error?u.message:String(u)}}}case"OPEN_SIDEPANEL":{const i=await chrome.tabs.query({active:!0,currentWindow:!0});return(a=i[0])!=null&&a.id&&await chrome.sidePanel.open({tabId:i[0].id}),{success:!0}}default:return{error:"Unknown message type"}}}setInterval(async()=>{for(const[,d]of m)await k(d)},3e4);chrome.runtime.onStartup.addListener(()=>{m.clear()});console.log("Quark background service worker initialized");
